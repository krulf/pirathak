#!/bin/bash

# SÃ¦t hjem
hjem=$(pwd)/pirathavn
startmappe=$hjem

kortfilen=$hjem/kort.md
helpfile=$hjem/.hjÃ¦lp.md

hjÃ¦lp() {
    glow -w 125 $helpfile
}

merehjÃ¦lp() {
    glow $hjem/.merehjÃ¦lp.md
}

start() {
    clear
    cd $startmappe
    glow .intro.md
}

kort() {
	clear
	glow $kortfilen
}

# OpgaverÃ¦kkefÃ¸lge
export hxr=0
export pape=0
export lager=0
export gemmested=0
export gemtbesked=0
export piratflag=0
export abe=0
export guldkiste=0
export unicorn=0

hxr_array=(	"finde ud af hvilken IP-adresse havnens server har, kig i kaptajnens kabys"
		"finde koden til serveren. Du lÃ¦gger mÃ¦rke til at sedlen med IP-adresser fra opslagstavlen har JÃ¸rgen Tietzes brugernavn \`jtietze\` - brug cewl pÃ¥ JÃ¸rgen Tietzes hjemmeside for at finde koden. Han elsker lange kodeord, sÃ¥ det skal mindst vÃ¦re 12 karakterer langt. Kan du huske hvordan cewl virker? Tjek kommandoen med \`hjÃ¦lp\`. Du har fundet den rette ordbog nÃ¥r den har bogstaverne \`XqkPk\` med - forskel pÃ¥ store og smÃ¥ bogstaver"
		"finde ud af hvad koden til serveren er. Brug brute-force vÃ¦rtkÃ¸jet hydra, som beskrevet i \`hjÃ¦lp\`. NÃ¥r du har fundet koden skal du eksportere den med: \`export kodeord=\` efterfulgt af koden"
		"logge ind pÃ¥ serveren med IP-adressen, brugernavnet og kodeordet du har fundet. Se hvordan kommandoen \`ssh\` virker i \`hjÃ¦lp\`"
)

opgave_array=(	"klare papegÃ¸jen pÃ¥ pirathavnen"
		"Ã¥bne kisterne i lageret pÃ¥ vestmolen"
		"hjÃ¦lpe redningstjenesten pÃ¥ Ã¸stmolen"
		"finde kaptajnens gemte besked pÃ¥ skattekortet i piratbaren pÃ¥ Ã¸stmolen"
		"finde koden hos kartografen pÃ¥ vestmolen"
		"snakke med den trehovedede abe i piratbaren pÃ¥ Ã¸stmolen"
		"Ã¥bne guldkisten i skibsvÃ¦rftet"
		"Ã¥bne simon milfreds kiste i vaskeriet"
		)

hvadnu() {
    if [[ hxr = 0 ]]; then
	opgave=1
	if [[ $pape = 1 ]]; then
	  	opgave=$((opgave+1))
	  	if [[ $lager = 1 ]]; then
	    		opgave=$((opgave+1))
	    		if [[ $gemmested = 1 ]]; then
	      			opgave=$((opgave+1))
				if [[ $gemtbesked = 1 ]]; then
					opgave=$((opgave+1))
					if [[ $piratflag = 1 ]]; then
		  				opgave=$((opgave+1))
						if [[ $abe = 1 ]]; then
							opgave=$((opgave+1))
							if [[ $guldkiste = 1 ]]; then
								opgave=$((opgave+1))
								if [[ $unicorn = 1 ]]; then
									opgave=$((opgave+1))
									echo "Du er klar til at komme ombord pÃ¥ piratskibet!"
									exit 0
			                    			fi
			                    		fi
		  				fi
					fi
				fi
			fi
	  	fi
	fi
	echo -e "# NÃ¦ste udfordring\n - Du skal ${opgave_array[$opgave]}"|glow
    else
	hxropg=1
	if [[ $IP == "0.0.0.0" ]]; then
		hxropg=$((hxropg+1))
		if [[ $kodeord == "sikkersystemTakoon" ]]; then
			hxropg=$((hxropg+1))
			
		fi
	fi
	echo -e "# NÃ¦ste udfordring\n - Du skal ${hxr_array[$hxropg]}"|glow
    fi
}

cd() {
    if [[ "$@" == *"piratskibet" ]] || [[ "$@" == *"piratskibet/" ]]; then
	if [[ "$(hvadnu)" == "Du er klar til at komme ombord pÃ¥ piratskibet!" ]]; then
		export hxr=1
		export starttime=$(cat $hjem/.starttime)
		export endtime=$(date +%s)
		export duration=$(($endtime - $starttime))
		echo
		echo "Whoaa! Tillykke du er kommet ombord! Det tog dig $(date -d@$duration -u +%H:%M:%S)."
		echo 
		echo "Rejs dig op og sig AAAARH!"
		sleep 3
		startmappe=$hjem/Ã¸stmolen/piratskibet
		kortfilen=$startmappe/.kort.md
		helpfile=$startmappe/.hackerhjÃ¦lp.md
		echo 
		echo -e "# Du har fÃ¥et et nyt kort\nSe det med kommandoen \`kort\`" | glow
		echo
		builtin cd "$@"
	else
		echo -e "# Du er ikke klar til at komme ombord!\n$(hvadnu)"|glow
	fi
    elif [[ "$@" == "gemmested" ]] || [[ "$@" == "gemmested/" ]]; then
        echo '
Fedt du slap vÃ¦k..!

Husk at lave variablen gemmested=1 med:
export gemmested=1'
    elif [[ -d pirathavn ]] && [[ "$@" == "pirathavn" ]] || [[ "$@" == "pirathavn/" ]]; then
	echo $(date +%s)>$hjem/.starttime
	echo
	echo "Velkommen til pirathavnen, tjek omgivelserne med: cat pirathavn"
	echo
	builtin cd "$@"
    else
        builtin cd "$@"
    fi
}

echo() {
	if [[ "$@" == "Skattekortet er begravet pÃ¥ Ã¸en Isolering" ]]; then
		builtin echo "$@"
		builtin echo 
		builtin echo "Hoved 2: Arrrh nej, det var ikke Isolering, men Loddetin - skriv det pirataspirant!"
		builtin echo
	elif [[ "$@" == "Skattekortet er begravet pÃ¥ Ã¸en Loddetin" ]]; then
		builtin echo
		builtin echo "Hoved 1: Fjumrehoveder! Det var da slet ikke en skat! Skriv i stedet: Skattekortet er blevet vÃ¦k"
		builtin echo
	elif [[ "$@" == "Skattekortet er blevet vÃ¦k" ]]; then
		builtin echo
		builtin echo -e "Du trÃ¦der lidt vÃ¦k, da abens tre hoveder begynder at rÃ¥be og skrige og bide efter hinanden.\n\nKort efter lÃ¸ber aben ud af dÃ¸ren."
		builtin echo
		builtin echo -e "Du kan nu sÃ¦tte variablen abe til 1 med kommandoen:\n\nexport abe=1"
		builtin echo 
		builtin echo -e "# BoboCocoLoco\nLiget af den trehovedede abe ligger og det er et skrÃ¦mmende og foruroligende syn. Dens tre hoveder er kastet tilbage i en uhyggelig vrangstilling, med Ã¥bne munde, der stadig ser ud til at rÃ¥be og skÃ¦nde, selv i dÃ¸den. Ã˜jnene er udtvÃ¦ret i en skrÃ¦mmende grimasse af smerte, og den kolde havbrise fÃ¥r dens pels til at bÃ¸lge som spÃ¸gelsesagtige skygger.\n\nDe omkringliggende mÃ¥ger er tavse og er flygtet vÃ¦k. Stilheden er kun afbrudt af de dystre bÃ¸lgers sagte klukken. Det er som om, Ã¸stmolen selv bÃ¦rer ar fra den trehovedede abes gruopvÃ¦kkende dÃ¸d, og det sender en kuldegysning ned ad ryggen pÃ¥ enhver, der tÃ¸r nÃ¦rme sig.\n\n">$hjem/Ã¸stmolen/trehovedetabe.md
		rm trehovedetabe.md
	elif [[ "$@" == "Skatteko"* ]]; then
		builtin echo
		builtin echo "Hoved $((1 + $RANDOM % 3)): Aaaarh! PrÃ¸v igen!"
		builtin echo 
	else
		builtin echo "$@"
	fi
}

alias piratflag='echo -e "# SÃ¥dan matroser....\n\n###I har nu fuldfÃ¸rt denne opgave og kan gÃ¥ videre. MÃ¥ vinden altid vÃ¦re i jeres sejl, og mÃ¥ skattejagterne aldrig ende!\n\nLykke og held! ðŸ´â€â˜ ï¸ðŸ’°\n\nSkriv \`export piratflag=1\` sÃ¥ gemmer du dine fremskridt.\n\nDu kan tjekke om dine fremskridt er gemt med \`echo \$piratflag\`" | glow'

.check_ip.sh > /dev/null 2>&1 &
